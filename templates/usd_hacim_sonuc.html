<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ sembol }} | USD Hacim Terminali</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --bg: #030712;
            --card-bg: #0f172a;
            --accent-green: #00ffbb;
            --accent-red: #ff4b5c;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border: rgba(255,255,255,0.1);
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 20px; overflow-x: hidden;
        }

        .dashboard { max-width: 1400px; margin: 0 auto; }

        /* Header Modern */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%);
            padding: 25px 35px; border-radius: 20px; border: 1px solid var(--border);
            margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .symbol-box h1 { margin: 0; font-size: 28px; font-weight: 800; letter-spacing: -1px; }
        .symbol-badge { background: var(--accent-green); color: #000; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 900; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }

        .stat-card {
            background: var(--card-bg); padding: 20px; border-radius: 18px;
            border: 1px solid var(--border); position: relative; overflow: hidden;
        }

        .label { color: var(--text-dim); font-size: 12px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .value { font-size: 22px; font-weight: 800; }

        /* Chart Section - Yükseklik hatasını çözen kısım */
        .chart-container {
            background: var(--card-bg); border-radius: 24px; border: 1px solid var(--border);
            padding: 20px; min-height: 550px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        #volumeChart { width: 100%; height: 500px; }

        .footer-actions { display: flex; gap: 15px; margin-top: 25px; justify-content: flex-end; }
        .btn {
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 12px;
            text-decoration: none; font-weight: 700; border: 1px solid var(--border); cursor: pointer; transition: 0.2s;
        }
        .btn-print { background: var(--accent-green); color: #000; border: none; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="header">
            <div class="symbol-box">
                <span class="symbol-badge">LIVE USD VOLUME</span>
                <h1>{{ sembol }} <span style="color: var(--text-dim); font-weight: 300;">ANALYSIS</span></h1>
            </div>
            <div style="text-align: right;">
                <span class="label">Volume Deviation</span>
                <span class="value" style="color: {% if usd_hacim_fark_yuzde > 0 %}var(--accent-green){% else %}var(--accent-red){% endif %};">
                    {{ "%+ .2f"|format(usd_hacim_fark_yuzde) }}%
                </span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="label">Current USD Volume</span>
                <span class="value">$ {{ "{:,.0f}".format(son_usd_hacim) }}</span>
            </div>
            <div class="stat-card" style="border-bottom: 3px solid var(--accent-green);">
                <span class="label">Period ATH</span>
                <span class="value" style="color: var(--accent-green);">$ {{ "{:,.0f}".format(en_yüksek_hacim) }}</span>
                <div style="font-size: 10px; color: var(--text-dim);">Date: {{ en_yüksek_tarih }}</div>
            </div>
            <div class="stat-card" style="border-bottom: 3px solid var(--accent-red);">
                <span class="label">Period ATL</span>
                <span class="value" style="color: var(--accent-red);">$ {{ "{:,.0f}".format(en_düşük_hacim) }}</span>
                <div style="font-size: 10px; color: var(--text-dim);">Date: {{ en_düşük_tarih }}</div>
            </div>
            <div class="stat-card">
                <span class="label">System Status</span>
                <span class="value" style="color: var(--accent-green);"><i class="fas fa-check-circle"></i> SECURE</span>
            </div>
        </div>

        <div class="chart-container">
            <div id="volumeChart"></div>
        </div>

        <div class="footer-actions">
            <a href="/USD_HACİM" class="btn"><i class="fas fa-undo"></i> Return</a>
            <button onclick="saveSnapshot()" class="btn btn-print"><i class="fas fa-camera"></i> Snapshot Analysis</button>
        </div>
    </div>

    <script>
    // 1. Python'dan gelen veriyi tek bir kanal üzerinden (usd_hacim_grafik_url) alıyoruz
    try {
        const rawData = {{ usd_hacim_grafik_url | safe }};

        const config = {
            responsive: true,
            displaylogo: false,
            modeBarButtonsToAdd: ['drawline', 'drawrect', 'eraseshape'],
            displayModeBar: true
        };

        // Layout Override: Python'dan gelen layout'u HTML boyutlarına zorluyoruz
        const layout = {
            ...rawData.layout,
            autosize: true,
            height: 500, // Sabit yükseklik
            margin: { l: 50, r: 50, t: 30, b: 50 },
            paper_bgcolor: 'rgba(0,0,0,0)', // Şeffaf arka plan
            plot_bgcolor: 'rgba(0,0,0,0)',
            dragmode: 'pan'
        };

        // Grafiği çiz
        Plotly.newPlot('volumeChart', rawData.data, layout, config);

    } catch (err) {
        console.error("Grafik verisi yüklenirken hata oluştu:", err);
        document.getElementById('volumeChart').innerHTML =
            `<div style="color: var(--accent-red); padding: 100px; text-align:center;">
                <h3>GRAFİK_VERİ_HATASI</h3>
                <p>${err.message}</p>
            </div>`;
    }

    // Snapshot alma fonksiyonu
    function saveSnapshot() {
        Plotly.downloadImage('volumeChart', {
            format: 'png',
            width: 1200,
            height: 600,
            filename: '{{ sembol }}_USD_Volume_Analysis'
        });
    }

    // Pencere yeniden boyutlandırıldığında grafiği güncelle
    window.onresize = function() {
        Plotly.Plots.resize(document.getElementById('volumeChart'));
    };
    </script>
</body>
</html>
